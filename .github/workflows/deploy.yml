name: Deploy Hugo Site

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages

    steps:
      # 1. Checkout the repo (with submodules for theme)
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # 2. Setup Hugo
      - uses: peaceiris/actions-hugo@v3
        with:
          extended: true

      # 2.5. Fetch editorial board from GitHub team (optional: set GH_EDITORS_TOKEN with read:org)
      - name: Fetch editors from GitHub team
        env:
          GH_TOKEN: ${{ secrets.GH_EDITORS_TOKEN }}
          ORG: genomicsxai
          TEAM: editors
        run: |
          mkdir -p data
          if [ -z "$GH_TOKEN" ]; then
            echo '[]' > data/editors.json
            echo "No GH_EDITORS_TOKEN set; editorial board will be empty. Add a PAT with read:org to populate."
            exit 0
          fi
          PAGE=1
          ALL=""
          while true; do
            RES=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/${ORG}/teams/${TEAM}/members?per_page=100&page=${PAGE}")
            CODE=$(echo "$RES" | tail -n1)
            BODY=$(echo "$RES" | sed '$d')
            if [ "$CODE" != "200" ]; then
              echo "GitHub API returned $CODE; writing empty editors list."
              echo '[]' > data/editors.json
              exit 0
            fi
            COUNT=$(echo "$BODY" | jq -r 'length')
            [ "$COUNT" -eq 0 ] && break
            if [ -z "$ALL" ]; then ALL="$BODY"; else ALL=$(printf '%s\n%s' "$ALL" "$BODY" | jq -s 'add'); fi
            [ "$COUNT" -lt 100 ] && break
            PAGE=$((PAGE+1))
          done
          # Fetch each member's profile for display name (GET /users/{login} returns .name)
          OUT="[]"
          for login in $(echo "$ALL" | jq -r '.[].login'); do
            USER=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/users/${login}")
            NAME=$(echo "$USER" | jq -r '.name // empty')
            URL=$(echo "$USER" | jq -r '.html_url // empty')
            [ -z "$URL" ] && URL="https://github.com/${login}"
            ENTRY=$(jq -nc --arg login "$login" --arg url "$URL" --arg name "$NAME" '{login: $login, url: $url, name: (if $name == "" then null else $name end)}')
            OUT=$(echo "$OUT" "$ENTRY" | jq -s '.[0] + [.[1]]')
          done
          echo "$OUT" > data/editors.json
          echo "Fetched $(jq length data/editors.json) editor(s)."

      # 3. Build the Hugo site
      - name: Build
        run: hugo --minify

      # 3.5. Verify build output
      - name: List built files
        run: |
          echo "Build output directory contents:"
          ls -la public/ || echo "public directory not found!"
          echo ""
          echo "Checking for index.html:"
          ls -la public/index.html || echo "index.html not found!"
          echo ""
          echo "First few files in public:"
          find public -type f -name "*.html" | head -10

      # 4. Deploy to GitHub Pages
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          # Use PAT to bypass branch protection rules
          # Fallback to GITHUB_TOKEN if PAT is not set
          github_token: ${{ secrets.GH_PAGES_TOKEN || secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          # Explicitly set the branch name
          publish_branch: gh-pages
          # Don't keep old files - ensure clean deployment
          keep_files: false
          # Force orphan to start completely fresh (removes all old files)
          force_orphan: true

