{{- $image := partial "helper/image" (dict "Resources" .Page.Resources "Image" .Destination) -}}
{{- $alt := .PlainText | safeHTML -}}
{{- $title := .Title | markdownify -}}
{{- $parsedW := partial "parse-image-width" . | strings.TrimSpace -}}
{{- $parsedH := partial "parse-image-height" . | strings.TrimSpace -}}
{{- $attrWidth := or .Attributes.width $parsedW -}}
{{- $attrHeight := or .Attributes.height $parsedH -}}
{{- $attrClass := .Attributes.class -}}

{{/* Theme helper returns empty string when resource not found; then avoid accessing .Height on string */}}
{{- with $image -}}
	{{- if .Permalink -}}
		{{- $galleryImage := and .Height .Width (not $attrWidth) (not $attrHeight) -}}
		<img src="{{ .Permalink }}"
			{{- if $attrWidth }} width="{{ $attrWidth }}"{{ else }}{{ with .Width }} width="{{ . }}"{{ end }}{{ end -}}
			{{- if $attrHeight }} height="{{ $attrHeight }}"{{ else }}{{ with .Height }} height="{{ . }}"{{ end }}{{ end -}}
			loading="lazy"
			{{ with $alt }}alt="{{ . }}"{{ end }}
			{{ with $title }}title="{{ . }}" data-title-escaped="{{ $title | htmlEscape }}"{{ end }}
			{{- if $attrClass }} class="{{ $attrClass }}"{{ else if $galleryImage }} class="gallery-image" data-flex-grow="{{ div (mul .Width 100) .Height }}" data-flex-basis="{{ div (mul .Width 240) .Height }}px"{{ end }}>
	{{- else -}}
		<img src="{{ $.Destination | safeURL }}" loading="lazy"{{ with $attrWidth }} width="{{ . }}"{{ end }}{{ with $attrHeight }} height="{{ . }}"{{ end }}{{ with $attrClass }} class="{{ . }}"{{ end }}{{ with $alt }} alt="{{ . }}"{{ end }}>
	{{- end -}}
{{- else -}}
	<img src="{{ .Destination | safeURL }}" loading="lazy"{{ with $attrWidth }} width="{{ . }}"{{ end }}{{ with $attrHeight }} height="{{ . }}"{{ end }}{{ with $attrClass }} class="{{ . }}"{{ end }}{{ with $alt }} alt="{{ . }}"{{ end }}>
{{- end -}}
