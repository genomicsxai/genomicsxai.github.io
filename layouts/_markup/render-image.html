{{- $image := partial "helper/image" (dict "Resources" .Page.Resources "Image" .Destination) -}}
{{- $alt := .PlainText | safeHTML -}}
{{- $title := .Title | markdownify -}}
{{/* Parse width=N / height=N from image title (Goldmark does not pass attribute blocks to image hooks) */}}
{{- $titleStr := printf "%s" .Title -}}
{{- $mw := findRESubmatch "width=(\\d+)" $titleStr -}}
{{- $mh := findRESubmatch "height=(\\d+)" $titleStr -}}
{{/* Strip width=N / height=N from title so hover tooltip shows only descriptive text */}}
{{- $displayTitle := replaceRE "width=[0-9]+(px)?[ \t]*" "" $titleStr -}}
{{- $displayTitle = replaceRE "height=[0-9]+(px)?[ \t]*" "" $displayTitle -}}
{{- $displayTitle = replaceRE "^[ \t]+" "" $displayTitle -}}
{{- $displayTitle = replaceRE "[ \t]+$" "" $displayTitle -}}
{{- .Page.Scratch.Set "imgw" "" -}}{{- with $mw }}{{- with index . 0 }}{{- $.Page.Scratch.Set "imgw" (index . 1 | printf "%spx") -}}{{- end }}{{- end -}}
{{- .Page.Scratch.Set "imgh" "" -}}{{- with $mh }}{{- with index . 0 }}{{- $.Page.Scratch.Set "imgh" (index . 1 | printf "%spx") -}}{{- end }}{{- end -}}
{{- $attrWidth := or .Attributes.width (.Page.Scratch.Get "imgw") -}}
{{- $attrHeight := or .Attributes.height (.Page.Scratch.Get "imgh") -}}
{{- $attrClass := .Attributes.class -}}

{{/* Theme helper returns empty string when resource not found; then avoid accessing .Height on string */}}
{{- with $image -}}
	{{- if .Permalink -}}
		{{- $galleryImage := and .Height .Width (not $attrWidth) (not $attrHeight) -}}
		<figure><a href="{{ .Permalink }}" class="image-link" data-pswp-width="{{ .Width }}" data-pswp-height="{{ .Height }}">
		<img src="{{ .Permalink }}"
			{{- if $attrWidth }} width="{{ $attrWidth }}"{{ else }}{{ with .Width }} width="{{ . }}"{{ end }}{{ end -}}
			{{- if $attrHeight }} height="{{ $attrHeight }}"{{ else }}{{ with .Height }} height="{{ . }}"{{ end }}{{ end -}}
			loading="lazy"
			{{ with $alt }}alt="{{ . }}"{{ end }}
			{{ with $displayTitle }}title="{{ . }}" data-title-escaped="{{ $displayTitle | htmlEscape }}"{{ end }}
			{{- if $attrClass }} class="{{ $attrClass }}"{{ else if $galleryImage }} class="gallery-image" data-flex-grow="{{ div (mul .Width 100) .Height }}" data-flex-basis="{{ div (mul .Width 240) .Height }}px"{{ end }}>
		</a></figure>
	{{- else -}}
		<figure><a href="{{ $.Destination | safeURL }}" class="image-link" target="_blank" rel="noopener">
		<img src="{{ $.Destination | safeURL }}" loading="lazy"{{ with $attrWidth }} width="{{ . }}"{{ end }}{{ with $attrHeight }} height="{{ . }}"{{ end }}{{ with $attrClass }} class="{{ . }}"{{ end }}{{ with $alt }} alt="{{ . }}"{{ end }}>
		</a></figure>
	{{- end -}}
{{- else -}}
	<figure><a href="{{ .Destination | safeURL }}" class="image-link" target="_blank" rel="noopener">
	<img src="{{ .Destination | safeURL }}" loading="lazy"{{ with $attrWidth }} width="{{ . }}"{{ end }}{{ with $attrHeight }} height="{{ . }}"{{ end }}{{ with $attrClass }} class="{{ . }}"{{ end }}{{ with $alt }} alt="{{ . }}"{{ end }}>
	</a></figure>
{{- end -}}
